<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>è³¦èƒ½é™ªè·‘æ—¥èªŒ</title>
    <style>
        :root {
            --primary-yellow: #F59E0B; 
            --primary-hover: #D97706;      
            --slate-blue: #1F2937;     
            --accent-green: #10B981;        
            --bg-pure: #FFFFFF;          
            --panel-bg: #FFFFFF;       
            --input-bg: #F8FAFC;       
            --text-dark: #111827;          
            --text-muted: #6B7280;     
            --glass-border: #CBD5E1;       
            --radius-soft: 12px; 
            --danger-color: #EF4444;   
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', sans-serif; line-height: 1.8; max-width: 800px; margin: 0 auto; padding: 40px 20px; background: var(--bg-pure); color: var(--text-dark); min-height: 100vh; }
        h1, h2, h3 { color: var(--slate-blue); font-weight: bold; margin-bottom: 20px; }
        h1 { font-size: 1.8rem; text-align: center; margin-bottom: 30px;}
        
        .section { background: var(--panel-bg); padding: 35px; margin-bottom: 25px; border-radius: var(--radius-soft); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .input-box, textarea, select { padding: 14px 18px; border: 1px solid var(--glass-border); border-radius: 8px; font-size: 16px !important; width: 100%; margin-bottom: 15px; background: var(--input-bg); color: var(--text-dark); font-family: inherit; transition: all 0.3s ease; }
        .input-box:focus, textarea:focus { outline: none; border-color: var(--primary-yellow); background: var(--bg-pure); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
        textarea { min-height: 120px; resize: vertical; }
        
        button { background: var(--primary-yellow); color: #ffffff; border: none; padding: 14px 28px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; width: 100%; transition: background 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 8px;}
        button:hover { background: var(--primary-hover); } 
        button:disabled { background: #E5E7EB; color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
        .btn-outline { background: var(--input-bg); color: var(--slate-blue); border: 1px solid var(--glass-border); box-shadow: none; }
        .btn-danger { background: var(--danger-color); box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2); } 
        
        .search-box { width: 100%; padding: 14px 18px; border: 1px solid var(--glass-border); border-radius: 8px; font-size: 1rem; background: var(--input-bg); margin-bottom: 20px; }
        .filter-section { background: var(--panel-bg); margin-bottom: 25px; padding: 20px; border-radius: var(--radius-soft); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .filter-title { margin-bottom: 10px; font-weight: bold; color: var(--slate-blue); font-size: 0.9em; }
        .category-nav { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .cat-btn { background: var(--input-bg); color: var(--text-muted); padding: 8px 18px; border-radius: 30px; border: 1px solid var(--glass-border); font-size: 0.9em; font-weight: bold; cursor: pointer; width: auto; margin-bottom: 0; box-shadow: none; }
        .cat-btn.active, .cat-btn:hover { background: var(--primary-yellow); color: #ffffff; border-color: var(--primary-yellow); }

        .post-card { background: var(--panel-bg); border: 1px solid var(--glass-border); padding: 30px; margin-bottom: 25px; border-radius: var(--radius-soft); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .post-title-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 10px; }
        .post-title { font-size: 1.4em; margin: 0; font-weight: bold; color: var(--text-dark); }
        .tag-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: bold; color: white; display: inline-block; white-space: nowrap; }
        .tag-pending { background: #EF4444; animation: pulse 2s infinite; }
        .tag-replied { background: var(--accent-green); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .post-meta { font-size: 0.85em; color: var(--text-muted); margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap; }
        .post-meta span { background: var(--input-bg); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--glass-border); color: var(--slate-blue); font-weight: bold;}
        .post-excerpt { color: var(--text-dark); margin-bottom: 20px; white-space: pre-wrap; font-size: 1.05rem; }
        
        .cta-container { display: none; padding: 50px 20px; text-align: center; background: #f8fafc; flex-direction: column; justify-content: center; align-items: center; border-radius: var(--radius-soft); border: 1px dashed var(--glass-border); margin-top: 20px; }

        .thread-item { background: var(--input-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid var(--glass-border); position: relative;}
        .thread-item.coach { border-left-color: var(--accent-green); background: #F0FDF4; }
        .thread-item.student { border-left-color: var(--primary-yellow); }
        .thread-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em; border-bottom: 1px dashed #ccc; padding-bottom: 8px;}
        .thread-role { font-weight: bold; color: var(--slate-blue); }
        .thread-time { color: var(--text-muted); }
        .thread-video-link { display: inline-block; margin-top: 15px; padding: 8px 16px; background: var(--slate-blue); color: #fff; text-decoration: none; border-radius: 6px; font-size: 0.9em; font-weight: bold; }
        .thread-video-link:hover { background: #000; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .page-btn { background: var(--panel-bg); color: var(--slate-blue); border: 1px solid var(--glass-border); padding: 8px 16px; border-radius: 6px; cursor: pointer; width: auto; margin-bottom: 0; box-shadow: none; }
        .page-btn.active { background: var(--primary-yellow); color: #ffffff; border-color: var(--primary-yellow); }
        
        .inline-msg { font-weight: bold; display: block; margin-top: 5px; min-height: 24px; color: var(--danger-color); }
        .inline-msg.success { color: var(--accent-green); }
        .system-msg { text-align: center; color: var(--slate-blue); padding: 30px; font-weight: bold; }

        /* éŒ„å½±ç¥å™¨ UI (åŸç”Ÿç„¡å¡é “ç‰ˆ) */
        .recorder-box { background: #f1f5f9; border: 2px dashed var(--slate-blue); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; transition: all 0.3s ease;}
        .recorder-box.recording { border-color: var(--danger-color); background: #fef2f2; animation: borderPulse 2s infinite; }
        @keyframes borderPulse { 0% { border-color: var(--danger-color); } 50% { border-color: #fca5a5; } 100% { border-color: var(--danger-color); } }
        #preview-video { width: 100%; max-width: 600px; border-radius: 8px; background: #000; margin-top: 15px; display: none; aspect-ratio: 16/9; }
        .controls-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .record-hint { font-size: 0.85rem; color: var(--danger-color); margin-bottom: 10px; font-weight: bold; display: inline-block; padding: 6px 12px; background: #fef2f2; border-radius: 6px; }
    </style>
</head>
<body>

    <h1>è³¦èƒ½é™ªè·‘æ—¥èªŒ</h1>

    <div class="section" id="login-section">
        <h3 style="margin-top:0;">æœƒå“¡é€šè¡Œè­‰</h3>
        <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 20px;">ç‚ºä¿éšœå­¸å“¡éš±ç§ï¼Œé™ªè·‘æ—¥èªŒéœ€é©—è­‰èº«åˆ†æ–¹å¯é€²å…¥ã€‚ç™»å…¥å¾Œå¯ç™¼èµ·æå•ä¸¦æŸ¥çœ‹æ‚¨çš„å°ˆå±¬æ—¥èªŒã€‚</p>
        <p id="login-status" style="color: var(--primary-yellow); font-weight: bold; margin-bottom: 15px;">ç›®å‰ç‹€æ…‹ï¼šæœªç™»å…¥ (è¨ªå®¢)</p>
        
        <div id="step-1" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="email" id="email" class="input-box" placeholder="è¼¸å…¥æœƒå“¡ Email" style="flex: 2; margin-bottom: 0;">
            <button onclick="requestOTP()" id="btn-otp" style="flex: 1; margin-bottom: 0; width: auto;">å¯„é€é©—è­‰ç¢¼</button>
            <span id="otp-msg" class="inline-msg" style="width: 100%;"></span>
        </div>
        
        <div id="step-2" style="display: none; margin-top: 10px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="otp-code" class="input-box" placeholder="è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼" style="flex: 2; margin-bottom: 0;">
                <button onclick="verifyLogin()" id="btn-login" style="flex: 1; margin-bottom: 0; width: auto;">ç™»å…¥é€šè¡Œ</button>
                <button onclick="cancelLogin()" class="btn-outline" style="flex: 1; margin-bottom: 0; width: auto;">è¿”å›</button>
            </div>
            <span id="login-msg" class="inline-msg" style="width: 100%;"></span>
        </div>
        <button id="btn-logout" onclick="logout()" style="display: none; background: var(--danger-color); width: auto; margin-top: 20px;">ç™»å‡ºå¸³è™Ÿ</button>
    </div>

    <div class="section" id="publish-section" style="display: none; border-left: 5px solid var(--primary-yellow);">
        <h3 style="margin-top:0;">ç™¼èµ·æ–°æå•</h3>
        
        <div id="recorder-container" class="recorder-box">
            <h4 style="margin: 0 0 10px 0; color: var(--slate-blue);">ğŸ¥ ç¶²é å…§å»ºéŒ„å½±ç¥å™¨ (è‡ªå‹•ä¸Šå‚³ç‰ˆ)</h4>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">å…å®‰è£è»Ÿé«”ï¼ç›´æ¥éŒ„è£½è¢å¹•èˆ‡èªéŸ³ã€‚éŒ„è£½å®Œç•¢å¾Œç³»çµ±å°‡<strong style="color:var(--accent-green);">è‡ªå‹•ä¸Šå‚³</strong>ã€‚</p>
            <span class="record-hint">âš ï¸ æç¤ºï¼šè·³å‡ºé¸æ“‡è¦–çª—æ™‚ï¼Œå¼·çƒˆå»ºè­°é¸æ“‡ã€Œæ•´å€‹è¢å¹•ç•«é¢ã€ï¼Œé€™æ¨£åˆ‡æ›åˆ†é æ‰ä¸æœƒå®šæ ¼ï¼</span>

            <video id="preview-video" autoplay playsinline></video>
            
            <div class="controls-row">
                <button id="btn-setup-record" onclick="setupRecording()" class="btn-outline" style="width: auto;">1. å•Ÿå‹•è¢å¹•èˆ‡éº¥å…‹é¢¨æ¬Šé™</button>
                <button id="btn-start-record" onclick="startRecording()" class="btn-danger" style="display:none; width: auto;">ğŸ”´ é–‹å§‹éŒ„è£½ (å»ºè­° 3-5 åˆ†é˜å…§)</button>
                <button id="btn-stop-record" onclick="stopRecording()" style="display:none; background: var(--slate-blue); width: auto;">â¹ï¸ çµæŸéŒ„è£½ä¸¦è‡ªå‹•ä¸Šå‚³</button>
            </div>
            <p id="record-status-msg" style="font-size: 0.95rem; margin-top: 15px; font-weight: bold; display: none;"></p>
        </div>

        <input type="text" id="post-title" class="input-box" placeholder="æå•æ¨™é¡Œ (å¿…å¡«)">
        <input type="text" id="post-video" class="input-box" placeholder="å½±ç‰‡ç¶²å€ (éŒ„å½±å®Œæœƒè‡ªå‹•å¡«å…¥ï¼Œæˆ–æ‰‹å‹•è²¼ä¸Šç¶²å€)" style="background: #fff;">
        <input type="hidden" id="post-video-id"> 
        <textarea id="post-desc" class="input-box" placeholder="è«‹ç°¡è¿°æ‚¨çš„å•é¡Œæˆ–æä¾›ç›¸é—œç¨‹å¼ç¢¼..."></textarea>
        <button onclick="submitPost()" id="btn-submit-post">ğŸš€ ç™¼å¸ƒæå•</button>
        <span id="post-msg" class="inline-msg"></span>
    </div>

    <div id="list-section" style="display: none;">
        <input type="text" id="searchInput" class="search-box" placeholder="è¼¸å…¥é—œéµå­—æœå°‹æ¨™é¡Œæˆ–å…§å®¹..." oninput="filterPosts()">
        <div class="filter-section">
            <div class="filter-title">è™•ç†ç‹€æ…‹</div>
            <div class="category-nav" id="type-container"></div>
            <div class="filter-title" style="margin-top: 10px;">ç™¼ä½ˆæ—¥æœŸ</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="date" id="datePicker" class="input-box" style="width: auto; margin: 0;" onchange="filterPosts()">
                <button onclick="clearDateFilter()" class="cat-btn" style="background: var(--bg-pure);">æ¸…é™¤</button>
            </div>
        </div>
        <div id="loading-list" class="system-msg">æ­£åœ¨ç‚ºæ‚¨æº–å‚™é™ªè·‘ç´€éŒ„...</div>
        <div id="post-list"></div>
        <div id="pagination-container" class="pagination"></div>
    </div>

    <div class="section" id="detail-section" style="display: none; padding-top: 30px;">
        <button onclick="backToList()" class="btn-outline" style="width: auto; margin-bottom: 20px;">è¿”å›åˆ—è¡¨</button>
        <div class="post-meta" id="detail-meta" style="margin-top: 15px;"></div>
        <h2 id="detail-title" style="margin-top: 5px; font-size: 2em; color: var(--text-dark);"></h2>
        <hr style="border: 0; border-top: 1px solid var(--glass-border); margin: 25px 0;">
        
        <div id="auth-warning-container" class="cta-container">
            <h3 id="auth-warning-message" style="color: var(--slate-blue); margin-bottom: 20px; line-height: 1.6; font-size: 1.4rem;"></h3>
            <button id="auth-warning-btn" onclick="scrollToLogin()" style="width: auto; padding: 16px 32px; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2);">ğŸ‘‰ ç«‹å³ç™»å…¥è§£é–</button>
        </div>

        <div id="thread-content-wrapper" style="display: none;">
            <div id="thread-container"></div>
            
            <div style="margin-top:30px; border-top: 2px solid var(--glass-border); padding-top: 25px;">
                <h3 style="margin-top:0;">æ–°å¢å½±éŸ³å›è¦† / è¿½å•</h3>
                <input type="text" id="reply-video" class="input-box" placeholder="è²¼ä¸Šå›è¦†å½±ç‰‡ç¶²å€ (é¸å¡«)">
                <textarea id="reply-desc" class="input-box" placeholder="è«‹è¼¸å…¥å›è¦†çš„æ–‡å­—èªªæ˜æˆ–é€å­—ç¨¿..."></textarea>
                <button onclick="submitReply()" id="btn-submit-reply">é€å‡ºå›è¦†</button>
                <span id="reply-msg" class="inline-msg"></span>
            </div>
        </div>
    </div>

    <script>
        // ğŸš¨ æ›¿æ›æˆä½ çš„æœ€æ–° GAS ç¶²å€ï¼
        const GAS_LIVE_URL = 'https://script.google.com/macros/s/AKfycbxlskYCzmBvEovom6UtLKSm4odx_xFhvlOGE78qXURsZQVNDj2ym9WbSuIfQMNntLQc/exec';
        const ADMIN_EMAIL = 'alwayslucky2hand@gmail.com';

        let currentUserEmail = ''; 
        let allLiveData = []; 
        let currentPost = null; 
        let currentSearchQuery = '';
        let currentStatus = 'å…¨éƒ¨';
        let currentPage = 1;
        const itemsPerPage = 5;

        // --- ğŸ¥ åŸç”ŸéŒ„å½±ç¥å™¨æ ¸å¿ƒé‚è¼¯ (è§£æ±ºå¡é “èˆ‡å›éŸ³) ---
        let mediaRecorder;
        let recordedChunks = [];
        let combinedStream;
        let screenStream;
        let micStream;

        function showRecorderMsg(msg, isError = false, keep = false) {
            const msgEl = document.getElementById('record-status-msg');
            msgEl.innerText = msg;
            msgEl.style.color = isError ? "var(--danger-color)" : "var(--slate-blue)";
            msgEl.style.display = 'block';
            if(!keep && !isError) setTimeout(() => msgEl.style.display = 'none', 5000);
        }

        async function setupRecording() {
            showRecorderMsg("ğŸ”„ æ­£åœ¨è«‹æ±‚éº¥å…‹é¢¨èˆ‡è¢å¹•æ¬Šé™...", false, true);

            try {
                // 1. å¼·åˆ¶å–å¾—éº¥å…‹é¢¨è²éŸ³ 
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                } catch(micErr) {
                    showRecorderMsg("âŒ ç„¡æ³•å•Ÿå‹•ï¼šæ‚¨å¿…é ˆå…è¨±ã€Œéº¥å…‹é¢¨ã€æ¬Šé™ï¼Œå¦å‰‡ç„¡æ³•éŒ„è£½æ‚¨çš„è¬›è§£èªéŸ³å“¦ï¼", true, true);
                    return;
                }

                // 2. å–å¾—ç´”è¢å¹•ç•«é¢ (æ‹’çµ•ç³»çµ±éŸ³ï¼Œå¾¹åº•é˜²å›éŸ³)
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { displaySurface: "monitor" }, 
                        audio: false // ç¦ç”¨ç³»çµ±è²éŸ³
                    });
                } catch(screenErr) {
                    showRecorderMsg("âŒ æ‚¨å–æ¶ˆäº†è¢å¹•åˆ†äº«ï¼Œè«‹é‡æ–°é»æ“Šå•Ÿå‹•ã€‚", true, true);
                    if(micStream) micStream.getTracks().forEach(t => t.stop());
                    return;
                }

                // 3. åŸç”Ÿçµåˆï¼šç•«é¢ + éº¥å…‹é¢¨ 
                combinedStream = new MediaStream([
                    ...screenStream.getVideoTracks(),
                    ...micStream.getAudioTracks() 
                ]);

                const previewVideo = document.getElementById('preview-video');
                previewVideo.srcObject = combinedStream;
                previewVideo.style.display = 'block';
                // ğŸš¨ ä¿®æ­£ï¼šéŒ„å½±ç•¶ä¸‹éœéŸ³é˜²å›éŸ³
                previewVideo.muted = true; 

                document.getElementById('btn-setup-record').style.display = 'none';
                document.getElementById('btn-start-record').style.display = 'block';
                showRecorderMsg("âœ… æˆæ¬ŠæˆåŠŸï¼è«‹é»æ“Šä¸‹æ–¹ç´…è‰²æŒ‰éˆ•é–‹å§‹éŒ„è£½ã€‚", false, true);

                screenStream.getVideoTracks()[0].onended = () => {
                    if(mediaRecorder && mediaRecorder.state === "recording") stopRecording();
                    resetRecordingUI();
                };

            } catch (err) {
                showRecorderMsg("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message, true, true);
            }
        }

        function startRecording() {
            recordedChunks = [];
            let options = { mimeType: 'video/webm;codecs=vp9,opus', videoBitsPerSecond: 800000 };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' }; 

            mediaRecorder = new MediaRecorder(combinedStream, options);
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };

            // ğŸŒŸ éŒ„è£½çµæŸå¾Œçš„ã€Œè‡ªå‹•ä¸Šå‚³ã€æµç¨‹
            mediaRecorder.onstop = async function() {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const previewVideo = document.getElementById('preview-video');
                previewVideo.srcObject = null; 
                previewVideo.src = URL.createObjectURL(blob); 
                previewVideo.controls = true;
                
                // ğŸš¨ é‡å¤§ä¿®æ­£ï¼šæ’­æ”¾æ™‚è§£é™¤éœéŸ³ï¼Œè®“ä½¿ç”¨è€…èƒ½è½åˆ°è‡ªå·±çš„è²éŸ³ï¼
                previewVideo.muted = false; 
                
                document.getElementById('btn-stop-record').style.display = 'none';
                document.getElementById('recorder-container').classList.remove('recording');
                
                // é—œé–‰ç¡¬é«”å­˜å–
                if(screenStream) screenStream.getTracks().forEach(t => t.stop());
                if(micStream) micStream.getTracks().forEach(t => t.stop());

                // é–‹å§‹è‡ªå‹•ä¸Šå‚³
                showRecorderMsg("â³ å½±ç‰‡è™•ç†èˆ‡ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™ï¼ˆç´„éœ€ 10~30 ç§’ï¼Œè«‹å‹¿é—œé–‰ç¶²é ï¼‰...", false, true);
                
                try {
                    const base64Data = await blobToBase64(blob);
                    const payload = {
                        action: 'upload_video',
                        base64Data: base64Data,
                        mimeType: 'video/webm',
                        filename: `Temp_${Date.now()}.webm`
                    };
                    
                    const res = await fetch(GAS_LIVE_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const data = await res.json();
                    
                    if(data.status === 'success') {
                        document.getElementById('post-video').value = data.url;
                        document.getElementById('post-video-id').value = data.fileId;
                        showRecorderMsg("âœ… å½±ç‰‡ä¸Šå‚³æˆåŠŸï¼ç¶²å€å·²è‡ªå‹•å¡«å…¥ï¼Œè«‹å¡«å¯«æ¨™é¡Œå¾Œç™¼å¸ƒã€‚", false, true);
                        document.getElementById('record-status-msg').style.color = "var(--accent-green)";
                        document.getElementById('btn-setup-record').innerText = "é‡æ–°éŒ„è£½ (å°‡è¦†è“‹å‰ä¸€æ¬¡)";
                        document.getElementById('btn-setup-record').style.display = 'block';
                    } else {
                        showRecorderMsg("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + data.message, true, true);
                        document.getElementById('btn-setup-record').innerText = "é‡æ–°éŒ„è£½";
                        document.getElementById('btn-setup-record').style.display = 'block';
                    }
                } catch(e) {
                    showRecorderMsg("âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œä¸Šå‚³å¤±æ•—ã€‚å½±ç‰‡å¯èƒ½è¶…éé•·åº¦é™åˆ¶ã€‚", true, true);
                    document.getElementById('btn-setup-record').innerText = "é‡æ–°éŒ„è£½";
                    document.getElementById('btn-setup-record').style.display = 'block';
                }
            };

            mediaRecorder.start();
            document.getElementById('btn-start-record').style.display = 'none';
            document.getElementById('btn-stop-record').style.display = 'block';
            document.getElementById('recorder-container').classList.add('recording');
            showRecorderMsg("ğŸ”´ æ­£åœ¨éŒ„è£½ä¸­... æ‚¨ç¾åœ¨å¯ä»¥åˆ‡æ›åˆ°ä»»ä½•åˆ†é æˆ–è»Ÿé«”é€²è¡Œæ“ä½œã€‚", true, true);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
        }

        function resetRecordingUI() {
            document.getElementById('btn-setup-record').innerText = "1. å•Ÿå‹•è¢å¹•èˆ‡éº¥å…‹é¢¨æ¬Šé™";
            document.getElementById('btn-setup-record').style.display = 'block';
            document.getElementById('btn-start-record').style.display = 'none';
            document.getElementById('btn-stop-record').style.display = 'none';
            document.getElementById('preview-video').style.display = 'none';
            document.getElementById('record-status-msg').style.display = 'none';
            document.getElementById('recorder-container').classList.remove('recording');
        }

        function blobToBase64(blob) {
            return new Promise((resolve, _) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }
        // --- éŒ„å½±é‚è¼¯çµæŸ ---

        // --- ç¶²ç«™åŸºç¤é‚è¼¯ ---
        window.onload = function() {
            document.getElementById('list-section').style.display = 'block';
            renderTypeFilter();
            fetchLiveData();
        };

        function showAppMsg(id, text, isError=false) {
            const el = document.getElementById(id);
            el.innerText = text;
            el.className = isError ? "inline-msg" : "inline-msg success";
            setTimeout(() => el.innerText = '', 4000);
        }
        
        function scrollToLogin() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('email').focus();
        }

        function requestOTP() {
            const email = document.getElementById('email').value.trim();
            if (!email) return showAppMsg('otp-msg', 'è«‹å…ˆè¼¸å…¥ Email', true);
            document.getElementById('btn-otp').innerText = "å¯„é€ä¸­...";
            fetch(GAS_LIVE_URL, { method: 'POST', body: JSON.stringify({ action: 'requestOTP', email: email }) })
            .then(res => res.json()).then(data => {
                document.getElementById('btn-otp').innerText = "å¯„é€é©—è­‰ç¢¼";
                if (data.status === "error") return showAppMsg('otp-msg', data.message, true);
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'block';
            }).catch(() => { showAppMsg('otp-msg', 'é€£ç·šå¤±æ•—', true); document.getElementById('btn-otp').innerText = "å¯„é€é©—è­‰ç¢¼"; });
        }

        function verifyLogin() {
            const email = document.getElementById('email').value.trim();
            const otp = document.getElementById('otp-code').value.trim();
            if (!otp) return showAppMsg('login-msg', 'è«‹è¼¸å…¥é©—è­‰ç¢¼', true);

            document.getElementById('btn-login').innerText = "é©—è­‰ä¸­...";
            fetch(GAS_LIVE_URL, { method: 'POST', body: JSON.stringify({ action: 'verifyOTP', email: email, otp: otp }) })
            .then(res => res.json()).then(data => {
                document.getElementById('btn-login').innerText = "ç™»å…¥é€šè¡Œ";
                if (data.status === "error") return showAppMsg('login-msg', data.message, true);
                
                currentUserEmail = email;
                document.getElementById('login-status').innerText = `å·²ç™»å…¥å­¸å“¡ï¼š${email}`;
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'block';
                document.getElementById('publish-section').style.display = 'block';
                
                if(currentPost && document.getElementById('detail-section').style.display === 'block') {
                    enterClass(currentPost.courseId);
                }
            });
        }

        function cancelLogin() { document.getElementById('step-1').style.display = 'flex'; document.getElementById('step-2').style.display = 'none'; }
        function logout() { 
            currentUserEmail = ''; 
            document.getElementById('email').value = ''; 
            document.getElementById('otp-code').value = ''; 
            document.getElementById('login-status').innerText = 'ç›®å‰ç‹€æ…‹ï¼šæœªç™»å…¥ (è¨ªå®¢)'; 
            document.getElementById('step-1').style.display = 'flex'; 
            document.getElementById('btn-logout').style.display = 'none'; 
            document.getElementById('publish-section').style.display = 'none';
            document.getElementById('detail-section').style.display = 'none';
            document.getElementById('list-section').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderTypeFilter() {
            const container = document.getElementById('type-container'); 
            container.innerHTML = '';
            ['å…¨éƒ¨', 'å¾…å›è¦†', 'æ•™ç·´å·²å›è¦†', 'å­¸å“¡è¿½å•'].forEach(opt => {
                const btn = document.createElement('button'); 
                btn.className = opt === currentStatus ? 'cat-btn active' : 'cat-btn';
                btn.innerText = opt; 
                btn.onclick = () => { currentStatus = opt; currentPage = 1; renderTypeFilter(); filterPosts(); };
                container.appendChild(btn);
            });
        }

        function clearDateFilter() { document.getElementById('datePicker').value = ''; filterPosts(); }

        function fetchLiveData() {
            fetch(GAS_LIVE_URL).then(res => res.json()).then(data => {
                allLiveData = data.reverse(); 
                document.getElementById('loading-list').style.display = 'none';
                filterPosts();
            }).catch(err => { document.getElementById('loading-list').innerText = 'è³‡æ–™è¼‰å…¥å¤±æ•—'; });
        }

        function filterPosts() {
            currentSearchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            let dateQuery = document.getElementById('datePicker').value.replace(/-/g, '/'); 
            
            let filtered = allLiveData;
            if (currentSearchQuery) {
                filtered = filtered.filter(p => (p.title && p.title.toLowerCase().includes(currentSearchQuery)) || (p.desc && p.desc.toLowerCase().includes(currentSearchQuery)) || (p.courseId && p.courseId.toLowerCase().includes(currentSearchQuery)) );
            }
            if (currentStatus !== 'å…¨éƒ¨') filtered = filtered.filter(p => p.status === currentStatus);
            if (dateQuery) filtered = filtered.filter(p => p.date === dateQuery);

            renderList(filtered);
        }

        function renderList(filteredData) {
            const listContainer = document.getElementById('post-list');
            const pagination = document.getElementById('pagination-container');
            listContainer.innerHTML = ''; pagination.innerHTML = '';

            if (filteredData.length === 0) return listContainer.innerHTML = '<p class="system-msg">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„ï¼</p>';

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const postsToShow = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            postsToShow.forEach(post => {
                let badgeClass = post.status.includes('å·²å›è¦†') ? 'tag-replied' : 'tag-pending';
                
                listContainer.innerHTML += `
                    <div class="post-card">
                        <div class="post-title-row">
                            <h3 class="post-title">${post.title}</h3>
                            <span class="tag-badge ${badgeClass}">${post.status}</span>
                        </div>
                        <div class="post-meta">
                            <span>ç·¨è™Ÿï¼š${post.courseId}</span>
                            <span>ç™¼ä½ˆäººï¼š${post.email.split('@')[0]}***</span> 
                            <span>ç™¼ä½ˆæ–¼ï¼š${post.date} ${post.time}</span>
                        </div>
                        <div class="post-excerpt">${post.desc}</div>
                        <button onclick="enterClass('${post.courseId}')" class="btn-outline" style="width: auto;">é€²å…¥æ—¥èªŒ</button>
                    </div>`;
            });

            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button'); btn.className = `page-btn ${i === currentPage ? 'active' : ''}`; btn.innerText = i;
                    btn.onclick = () => { currentPage = i; renderList(filteredData); window.scrollTo({ top: 0, behavior: 'smooth' }); };
                    pagination.appendChild(btn);
                }
            }
        }

        function renderThread(post) {
            let html = '';
            let vidHtml = post.videoUrl ? `<a href="${post.videoUrl}" target="_blank" class="thread-video-link">ğŸ¥ è§€çœ‹åŸå§‹æå•å½±ç‰‡</a>` : '';
            html += `
                <div class="thread-item student">
                    <div class="thread-header">
                        <span class="thread-role">ğŸ‘¤ å­¸å“¡æå• (${post.email})</span>
                        <span class="thread-time">${post.date} ${post.time}</span>
                    </div>
                    <div class="post-excerpt">${post.desc.replace(/\n/g, '<br>')}</div>
                    ${vidHtml}
                </div>`;
            
            post.replies.forEach(reply => {
                let parts = reply.split('|||');
                if(parts.length >= 5) {
                    let rDate = parts[0], rTime = parts[1], rRole = parts[2], rEmail = parts[3], rContent = parts[4], rVid = parts[5] || '';
                    let itemClass = rRole === 'é™ªè·‘æ•™ç·´' ? 'coach' : 'student';
                    let rVidHtml = rVid ? `<a href="${rVid}" target="_blank" class="thread-video-link">ğŸ¥ è§€çœ‹å›è¦†å½±ç‰‡</a>` : '';
                    
                    html += `
                    <div class="thread-item ${itemClass}">
                        <div class="thread-header">
                            <span class="thread-role">${rRole === 'é™ªè·‘æ•™ç·´' ? 'ğŸ‘‘' : 'ğŸ‘¤'} ${rRole} (${rEmail})</span>
                            <span class="thread-time">${rDate} ${rTime}</span>
                        </div>
                        <div class="post-excerpt">${rContent.replace(/\n/g, '<br>')}</div>
                        ${rVidHtml}
                    </div>`;
                }
            });
            document.getElementById('thread-container').innerHTML = html;
        }

        function enterClass(courseId) {
            currentPost = allLiveData.find(p => p.courseId === courseId);
            if(!currentPost) return;

            document.getElementById('publish-section').style.display = 'none';
            document.getElementById('list-section').style.display = 'none';
            document.getElementById('detail-section').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

            document.getElementById('detail-title').innerText = currentPost.title;
            document.getElementById('detail-meta').innerHTML = `<span>ç·¨è™Ÿ: ${currentPost.courseId}</span> <span>ç‹€æ…‹: ${currentPost.status}</span>`;
            
            const authWarningContainer = document.getElementById('auth-warning-container');
            const authWarningMessage = document.getElementById('auth-warning-message');
            const authWarningBtn = document.getElementById('auth-warning-btn');
            const threadContentWrapper = document.getElementById('thread-content-wrapper');

            if (!currentUserEmail) {
                authWarningContainer.style.display = 'flex';
                threadContentWrapper.style.display = 'none';
                authWarningMessage.innerHTML = "ğŸ”’ é€™æ˜¯å°ˆå±¬é™ªè·‘æ—¥èªŒ<br>è«‹å…ˆç™»å…¥æˆ–åŠ å…¥æœƒå“¡ä»¥è§£é–æ‚¨çš„æ¬Šé™ï¼";
                authWarningBtn.style.display = 'inline-block';
            } else if (currentUserEmail.toLowerCase() !== currentPost.email.toLowerCase() && currentUserEmail.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                authWarningContainer.style.display = 'flex';
                threadContentWrapper.style.display = 'none';
                authWarningMessage.innerHTML = "â›” é€™æ˜¯å…¶ä»–å­¸å“¡çš„å°ˆå±¬é™ªè·‘æ—¥èªŒ<br>ç‚ºä¿éšœå­¸å“¡éš±ç§ï¼Œæ‚¨ç„¡æ¬Šè§€çœ‹å“¦ï¼";
                authWarningBtn.style.display = 'none'; 
            } else {
                authWarningContainer.style.display = 'none';
                threadContentWrapper.style.display = 'block';
                renderThread(currentPost);
            }
        }

        function submitPost() {
            const title = document.getElementById('post-title').value.trim();
            const desc = document.getElementById('post-desc').value.trim();
            const videoUrl = document.getElementById('post-video').value.trim();
            const videoFileId = document.getElementById('post-video-id').value; 
            const btn = document.getElementById('btn-submit-post');
            
            if(!title || !desc) return showAppMsg('post-msg', 'æ¨™é¡Œèˆ‡ç°¡è¿°ç‚ºå¿…å¡«ï¼', true);
            
            btn.disabled = true; btn.innerText = "ç™¼å¸ƒä¸­...";

            fetch(GAS_LIVE_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'add_post', 
                    email: currentUserEmail, 
                    title: title, 
                    desc: desc, 
                    videoUrl: videoUrl,
                    videoFileId: videoFileId 
                })
            }).then(() => {
                btn.disabled = false; btn.innerText = "ğŸš€ ç™¼å¸ƒæå•";
                document.getElementById('post-title').value = ''; 
                document.getElementById('post-desc').value = ''; 
                document.getElementById('post-video').value = '';
                document.getElementById('post-video-id').value = '';
                resetRecordingUI(); 
                showAppMsg('post-msg', 'æå•ç™¼å¸ƒæˆåŠŸï¼');
                fetchLiveData(); 
            });
        }

        function submitReply() {
            const desc = document.getElementById('reply-desc').value.trim();
            const videoUrl = document.getElementById('reply-video').value.trim();
            const btn = document.getElementById('btn-submit-reply');
            
            if(!desc) return showAppMsg('reply-msg', 'è«‹è¼¸å…¥å›è¦†å…§å®¹ï¼', true);
            
            btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";

            fetch(GAS_LIVE_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'add_reply', courseId: currentPost.courseId, email: currentUserEmail, desc: desc, videoUrl: videoUrl })
            }).then(() => {
                btn.disabled = false; btn.innerText = "é€å‡ºå›è¦†";
                document.getElementById('reply-desc').value = ''; document.getElementById('reply-video').value = '';
                showAppMsg('reply-msg', 'å›è¦†æˆåŠŸï¼é‡æ–°è¼‰å…¥ä¸­...');
                
                fetch(GAS_LIVE_URL).then(res=>res.json()).then(data => {
                    allLiveData = data.reverse();
                    enterClass(currentPost.courseId);
                });
            });
        }

        function backToList() {
            document.getElementById('detail-section').style.display = 'none';
            document.getElementById('list-section').style.display = 'block';
            if(currentUserEmail) document.getElementById('publish-section').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            filterPosts();
        }
    </script>
</body>
</html>
