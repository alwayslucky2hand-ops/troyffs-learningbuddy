<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>è³¦èƒ½é™ªè·‘æ—¥èªŒ</title>
    <style>
        :root {
            --primary-yellow: #F59E0B; 
            --primary-hover: #D97706;      
            --slate-blue: #1F2937;     
            --accent-green: #10B981;        
            --bg-pure: #FFFFFF;          
            --panel-bg: #FFFFFF;       
            --input-bg: #F8FAFC;       
            --text-dark: #111827;          
            --text-muted: #6B7280;     
            --glass-border: #CBD5E1;       
            --radius-soft: 12px; 
            --danger-color: #EF4444;   
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', sans-serif; line-height: 1.8; max-width: 800px; margin: 0 auto; padding: 40px 20px; background: var(--bg-pure); color: var(--text-dark); min-height: 100vh; }
        h1, h2, h3 { color: var(--slate-blue); font-weight: bold; margin-bottom: 20px; }
        h1 { font-size: 1.8rem; text-align: center; margin-bottom: 30px;}
        
        .section { background: var(--panel-bg); padding: 35px; margin-bottom: 25px; border-radius: var(--radius-soft); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .input-box, textarea, select { padding: 14px 18px; border: 1px solid var(--glass-border); border-radius: 8px; font-size: 16px !important; width: 100%; margin-bottom: 15px; background: var(--input-bg); color: var(--text-dark); font-family: inherit; transition: all 0.3s ease; }
        .input-box:focus, textarea:focus { outline: none; border-color: var(--primary-yellow); background: var(--bg-pure); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
        textarea { min-height: 120px; resize: vertical; }
        
        button { background: var(--primary-yellow); color: #ffffff; border: none; padding: 14px 28px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; width: 100%; transition: background 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 8px;}
        button:hover { background: var(--primary-hover); } 
        button:disabled { background: #E5E7EB; color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
        .btn-outline { background: var(--input-bg); color: var(--slate-blue); border: 1px solid var(--glass-border); box-shadow: none; }
        .btn-danger { background: var(--danger-color); box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2); } 
        
        .search-box { width: 100%; padding: 14px 18px; border: 1px solid var(--glass-border); border-radius: 8px; font-size: 1rem; background: var(--input-bg); margin-bottom: 20px; }
        .filter-section { background: var(--panel-bg); margin-bottom: 25px; padding: 20px; border-radius: var(--radius-soft); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .filter-title { margin-bottom: 10px; font-weight: bold; color: var(--slate-blue); font-size: 0.9em; }
        .category-nav { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .cat-btn { background: var(--input-bg); color: var(--text-muted); padding: 8px 18px; border-radius: 30px; border: 1px solid var(--glass-border); font-size: 0.9em; font-weight: bold; cursor: pointer; width: auto; margin-bottom: 0; box-shadow: none; }
        .cat-btn.active, .cat-btn:hover { background: var(--primary-yellow); color: #ffffff; border-color: var(--primary-yellow); }

        .post-card { background: var(--panel-bg); border: 1px solid var(--glass-border); padding: 30px; margin-bottom: 25px; border-radius: var(--radius-soft); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .post-title-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 10px; }
        .post-title { font-size: 1.4em; margin: 0; font-weight: bold; color: var(--text-dark); }
        .tag-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: bold; color: white; display: inline-block; white-space: nowrap; }
        .tag-pending { background: #EF4444; animation: pulse 2s infinite; }
        .tag-replied { background: var(--accent-green); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .post-meta { font-size: 0.85em; color: var(--text-muted); margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap; }
        .post-meta span { background: var(--input-bg); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--glass-border); color: var(--slate-blue); font-weight: bold;}
        .post-excerpt { color: var(--text-dark); margin-bottom: 20px; white-space: pre-wrap; font-size: 1.05rem; line-height: 1.6;}
        
        .cta-container { display: none; padding: 50px 20px; text-align: center; background: #f8fafc; flex-direction: column; justify-content: center; align-items: center; border-radius: var(--radius-soft); border: 1px dashed var(--glass-border); margin-top: 20px; }

        .thread-item { background: var(--input-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid var(--glass-border); position: relative;}
        .thread-item.coach { border-left-color: var(--accent-green); background: #F0FDF4; }
        .thread-item.student { border-left-color: var(--primary-yellow); }
        .thread-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em; border-bottom: 1px dashed #ccc; padding-bottom: 8px;}
        .thread-role { font-weight: bold; color: var(--slate-blue); }
        .thread-time { color: var(--text-muted); }

        .video-wrapper { margin-top: 15px; border-radius: 8px; overflow: hidden; background: #000; border: 1px solid var(--glass-border); box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .page-btn { background: var(--panel-bg); color: var(--slate-blue); border: 1px solid var(--glass-border); padding: 8px 16px; border-radius: 6px; cursor: pointer; width: auto; margin-bottom: 0; box-shadow: none; }
        .page-btn.active { background: var(--primary-yellow); color: #ffffff; border-color: var(--primary-yellow); }
        
        .inline-msg { font-weight: bold; display: block; margin-top: 5px; min-height: 24px; color: var(--danger-color); }
        .inline-msg.success { color: var(--accent-green); }
        .system-msg { text-align: center; color: var(--slate-blue); padding: 30px; font-weight: bold; }

        .recorder-box { background: #f1f5f9; border: 2px dashed var(--slate-blue); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; transition: all 0.3s ease;}
        .recorder-box.recording { border-color: var(--danger-color); background: #fef2f2; animation: borderPulse 2s infinite; }
        @keyframes borderPulse { 0% { border-color: var(--danger-color); } 50% { border-color: #fca5a5; } 100% { border-color: var(--danger-color); } }
        .preview-video-el { width: 100%; max-width: 600px; border-radius: 8px; background: #000; margin-top: 15px; display: none; aspect-ratio: 16/9; }
        .controls-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .record-hint { font-size: 0.85rem; color: var(--danger-color); margin-bottom: 10px; font-weight: bold; display: inline-block; padding: 6px 12px; background: #fef2f2; border-radius: 6px; line-height: 1.5; }
        
        .sop-box { background: #FFFBEB; border-left: 4px solid var(--primary-yellow); padding: 15px; margin-bottom: 20px; border-radius: 4px; text-align: left;}
        .sop-box strong { color: var(--slate-blue); font-size: 1.05rem; }
        .sop-box ol { margin-top: 8px; margin-bottom: 0; padding-left: 20px; color: var(--text-dark); font-size: 0.95rem; line-height: 1.6;}
    </style>
</head>
<body>

    <h1>ç‰¹æ´›ä¼Šè³¦èƒ½é™ªè·‘æ—¥èªŒ</h1>

    <div class="section" id="login-section">
        <h3 style="margin-top:0;">æœƒå“¡é€šè¡Œè­‰èˆ‡éŒ„å½±æ¬Šé™æŒ‡å—</h3>
        <div class="sop-box">
            <strong>ğŸ› ï¸ éŒ„å½±ç¥å™¨æ¬Šé™é–‹é€š SOPï¼ˆé¦–æ¬¡ä½¿ç”¨å¿…çœ‹ï¼‰ï¼š</strong>
            <ol>
                <li>è«‹é»æ“Šç€è¦½å™¨ç¶²å€åˆ—æœ€å·¦å´çš„ <strong>ã€Œé–é ­ ğŸ”’ã€</strong>ã€‚</li>
                <li>æ‰¾åˆ° <strong>ã€Œéº¥å…‹é¢¨ã€</strong> èˆ‡ <strong>ã€Œæ”å½±æ©Ÿã€</strong>ï¼Œå°‡å…¶ç‹€æ…‹åˆ‡æ›ç‚º <strong>ã€Œå…è¨±ã€</strong>ã€‚</li>
                <li>è¨­å®šå®Œæˆå¾Œï¼Œè«‹å‹™å¿… <strong>é‡æ–°æ•´ç† (F5) æ­¤ç¶²é </strong>ã€‚</li>
                <li>é»æ“ŠéŒ„è£½æ™‚ï¼Œè«‹é¸æ“‡ <strong>ã€Œæ•´å€‹è¢å¹•ç•«é¢ã€</strong> ä¸¦å‹™å¿…å‹¾é¸ <strong>ã€Œä¸€ä½µåˆ†äº«ç³»çµ±éŸ³è¨Šã€</strong>ï¼</li>
            </ol>
        </div>
        <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 20px;">ç‚ºä¿éšœå­¸å“¡éš±ç§ï¼Œè«‹å…ˆé©—è­‰èº«åˆ†ç™»å…¥ï¼Œå³å¯ç™¼èµ·æå•ä¸¦æŸ¥çœ‹æ‚¨çš„å°ˆå±¬é™ªè·‘æ—¥èªŒã€‚</p>
        <p id="login-status" style="color: var(--primary-yellow); font-weight: bold; margin-bottom: 15px;">ç›®å‰ç‹€æ…‹ï¼šæœªç™»å…¥ (è¨ªå®¢)</p>
        
        <div id="step-1" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="email" id="email" class="input-box" placeholder="è¼¸å…¥æœƒå“¡ Email" style="flex: 2; margin-bottom: 0;">
            <button onclick="requestOTP()" id="btn-otp" style="flex: 1; margin-bottom: 0; width: auto;">å¯„é€é©—è­‰ç¢¼</button>
            <span id="otp-msg" class="inline-msg" style="width: 100%;"></span>
        </div>
        
        <div id="step-2" style="display: none; margin-top: 10px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="otp-code" class="input-box" placeholder="è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼" style="flex: 2; margin-bottom: 0;">
                <button onclick="verifyLogin()" id="btn-login" style="flex: 1; margin-bottom: 0; width: auto;">ç™»å…¥é€šè¡Œ</button>
                <button onclick="cancelLogin()" class="btn-outline" style="flex: 1; margin-bottom: 0; width: auto;">è¿”å›</button>
            </div>
            <span id="login-msg" class="inline-msg" style="width: 100%;"></span>
        </div>
        <button id="btn-logout" onclick="logout()" style="display: none; background: var(--danger-color); width: auto; margin-top: 20px;">ç™»å‡ºå¸³è™Ÿ</button>
    </div>

    <div class="section" id="publish-section" style="display: none; border-left: 5px solid var(--primary-yellow);">
        <h3 style="margin-top:0;">ç™¼èµ·æ–°æå•</h3>
        <div id="post-recorder-container" class="recorder-box">
            <h4 style="margin: 0 0 10px 0; color: var(--slate-blue);">ğŸ¥ ç¶²é å…§å»ºéŒ„å½±ç¥å™¨ (ç„¡é™åˆ¶æ™‚é•·ç‰ˆ)</h4>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">ç³»çµ±å°‡åŒæ™‚æ“·å–ã€Œéº¥å…‹é¢¨ã€èˆ‡ã€Œé›»è…¦ç•«é¢è²éŸ³ã€ï¼Œè‹¥æœªå‹¾é¸ç³»çµ±éŸ³è¨Šå°‡ç„¡æ³•å•Ÿå‹•éŒ„å½±ã€‚</p>
            <label style="cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; font-weight: bold; color: var(--slate-blue);">
                <input type="checkbox" id="post-use-camera-cb" checked style="width: 18px; height: 18px;"> ğŸ“· åŒæ™‚é–‹å•Ÿè¦–è¨Šé¡é ­ (éœ²è‡‰)
            </label><br>
            <span class="record-hint">ğŸ’¡ é¸æ“‡åˆ†äº«ç•«é¢æ™‚ï¼šå¼·çƒˆå»ºè­°é¸æ“‡ã€Œæ•´å€‹è¢å¹•ç•«é¢ã€ï¼Œä¸¦å‹™å¿…å‹¾é¸ã€Œä¸€ä½µåˆ†äº«ç³»çµ±éŸ³è¨Šã€ã€‚</span>

            <video id="post-preview-video" class="preview-video-el" autoplay playsinline></video>
            
            <div class="controls-row">
                <button id="post-btn-setup-record" onclick="setupRecording('post')" class="btn-outline" style="width: auto;">1. å•Ÿå‹•å½±éŸ³éŒ„è£½æ¬Šé™</button>
                <button id="post-btn-start-record" onclick="startRecording('post')" class="btn-danger" style="display:none; width: auto;">ğŸ”´ é–‹å§‹éŒ„è£½ (æ”¯æ´ 10+ åˆ†é˜é•·å½±ç‰‡)</button>
                <button id="post-btn-stop-record" onclick="stopRecording('post')" style="display:none; background: var(--slate-blue); width: auto;">â¹ï¸ çµæŸéŒ„è£½ä¸¦è‡ªå‹•ä¸Šå‚³</button>
                <button id="post-btn-cancel-record" onclick="cancelRecording('post')" style="display:none; background: #fff; color: var(--slate-blue); border: 1px solid var(--glass-border); width: auto;">âŒ å–æ¶ˆéŒ„å½±</button>
            </div>
            <p id="post-record-status-msg" style="font-size: 0.95rem; margin-top: 15px; font-weight: bold; display: none;"></p>
        </div>

        <input type="text" id="post-title" class="input-box" placeholder="æå•æ¨™é¡Œ (å¿…å¡«)">
        <input type="text" id="post-video" class="input-box" placeholder="å½±ç‰‡ç¶²å€ (éŒ„å½±å®Œè‡ªå‹•å¡«å…¥ï¼Œæˆ–æ‰‹å‹•è²¼ç¶²å€)" style="background: #fff;" readonly>
        <input type="hidden" id="post-video-id"> 
        <textarea id="post-desc" class="input-box" placeholder="è«‹ç°¡è¿°æ‚¨çš„å•é¡Œæˆ–æä¾›ç›¸é—œç¨‹å¼ç¢¼..."></textarea>
        <button onclick="submitPost()" id="btn-submit-post">ğŸš€ ç™¼å¸ƒæå•</button>
        <span id="post-msg" class="inline-msg"></span>
    </div>

    <div id="list-section" style="display: none;">
        <input type="text" id="searchInput" class="search-box" placeholder="è¼¸å…¥é—œéµå­—æœå°‹æ¨™é¡Œæˆ–å…§å®¹..." oninput="filterPosts()">
        <div class="filter-section">
            <div class="filter-title">è™•ç†ç‹€æ…‹</div>
            <div class="category-nav" id="type-container"></div>
            <div class="filter-title" style="margin-top: 10px;">ç™¼ä½ˆæ—¥æœŸ</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="date" id="datePicker" class="input-box" style="width: auto; margin: 0;" onchange="filterPosts()">
                <button onclick="clearDateFilter()" class="cat-btn" style="background: var(--bg-pure);">æ¸…é™¤</button>
            </div>
        </div>
        <div id="loading-list" class="system-msg">æ­£åœ¨ç‚ºæ‚¨æº–å‚™é™ªè·‘ç´€éŒ„...</div>
        <div id="post-list"></div>
        <div id="pagination-container" class="pagination"></div>
    </div>

    <div class="section" id="detail-section" style="display: none; padding-top: 30px;">
        <button onclick="backToList()" class="btn-outline" style="width: auto; margin-bottom: 20px;">è¿”å›åˆ—è¡¨</button>
        <div class="post-meta" id="detail-meta" style="margin-top: 15px;"></div>
        <h2 id="detail-title" style="margin-top: 5px; font-size: 2em; color: var(--text-dark);"></h2>
        <hr style="border: 0; border-top: 1px solid var(--glass-border); margin: 25px 0;">
        
        <div id="auth-warning-container" class="cta-container">
            <h3 id="auth-warning-message" style="color: var(--slate-blue); margin-bottom: 20px; line-height: 1.6; font-size: 1.4rem;"></h3>
            <button id="auth-warning-btn" onclick="scrollToLogin()" style="width: auto; padding: 16px 32px; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2);">ğŸ‘‰ ç«‹å³ç™»å…¥è§£é–</button>
        </div>

        <div id="thread-content-wrapper" style="display: none;">
            <div id="thread-container"></div>
            
            <div style="margin-top:30px; border-top: 2px solid var(--glass-border); padding-top: 25px;">
                <h3 style="margin-top:0;">æ–°å¢å½±éŸ³å›è¦† / è¿½å•</h3>
                <div id="reply-recorder-container" class="recorder-box">
                    <h4 style="margin: 0 0 10px 0; color: var(--slate-blue);">ğŸ¥ ç¶²é å…§å»ºéŒ„å½±ç¥å™¨ (å›è¦†å°ˆç”¨)</h4>
                    <label style="cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; font-weight: bold; color: var(--slate-blue);">
                        <input type="checkbox" id="reply-use-camera-cb" checked style="width: 18px; height: 18px;"> ğŸ“· åŒæ™‚é–‹å•Ÿè¦–è¨Šé¡é ­ (éœ²è‡‰)
                    </label><br>
                    <span class="record-hint">âš ï¸ æç¤ºï¼šè«‹é¸æ“‡ã€Œæ•´å€‹è¢å¹•ç•«é¢ã€ï¼Œä¸¦å‹™å¿…å‹¾é¸ã€Œä¸€ä½µåˆ†äº«ç³»çµ±éŸ³è¨Šã€ã€‚</span>
                    <video id="reply-preview-video" class="preview-video-el" autoplay playsinline></video>
                    
                    <div class="controls-row">
                        <button id="reply-btn-setup-record" onclick="setupRecording('reply')" class="btn-outline" style="width: auto;">1. å•Ÿå‹•å½±éŸ³éŒ„è£½æ¬Šé™</button>
                        <button id="reply-btn-start-record" onclick="startRecording('reply')" class="btn-danger" style="display:none; width: auto;">ğŸ”´ é–‹å§‹éŒ„è£½ (æ”¯æ´ 10+ åˆ†é˜é•·å½±ç‰‡)</button>
                        <button id="reply-btn-stop-record" onclick="stopRecording('reply')" style="display:none; background: var(--slate-blue); width: auto;">â¹ï¸ çµæŸéŒ„è£½ä¸¦è‡ªå‹•ä¸Šå‚³</button>
                        <button id="reply-btn-cancel-record" onclick="cancelRecording('reply')" style="display:none; background: #fff; color: var(--slate-blue); border: 1px solid var(--glass-border); width: auto;">âŒ å–æ¶ˆéŒ„å½±</button>
                    </div>
                    <p id="reply-record-status-msg" style="font-size: 0.95rem; margin-top: 15px; font-weight: bold; display: none;"></p>
                </div>

                <input type="text" id="reply-video" class="input-box" placeholder="å½±ç‰‡ç¶²å€ (éŒ„å½±å®Œè‡ªå‹•å¡«å…¥ï¼Œæˆ–æ‰‹å‹•è²¼ç¶²å€)" style="background: #fff;" readonly>
                <input type="hidden" id="reply-video-id"> 
                <textarea id="reply-desc" class="input-box" placeholder="è«‹è¼¸å…¥å›è¦†çš„æ–‡å­—èªªæ˜æˆ–ç¨‹å¼ç¢¼..."></textarea>
                <button onclick="submitReply()" id="btn-submit-reply">ğŸš€ é€å‡ºå›è¦†</button>
                <span id="reply-msg" class="inline-msg"></span>
            </div>
        </div>
    </div>

    <script>
        // ğŸš¨ æ›¿æ›æˆä½ çš„æœ€æ–° GAS ç¶²å€ï¼
        const GAS_LIVE_URL = 'https://script.google.com/macros/s/AKfycbznNnl4RQLQH9vr_ms6L0xWj5yqDiVgPETskuhYu_gF6PFyiVXvT9636-nLJtLd244e/exec';
        const ADMIN_EMAIL = 'alwayslucky2hand@gmail.com';

        let currentUserEmail = ''; 
        let allLiveData = []; 
        let currentPost = null; 
        let currentSearchQuery = '';
        let currentStatus = 'å…¨éƒ¨';
        let currentPage = 1;
        const itemsPerPage = 5;

        // ==========================================
        // ğŸ¥ GAS ä¸­ç¹¼ç«™æ¥åŠ›ä¸Šå‚³å¼•æ“ (å®Œå…¨å…ç–« CORS)
        // ==========================================
        let mediaRecorder;
        let recordedChunks = [];
        let combinedStream;
        let screenStream;
        let micStream;
        let audioContext;
        let currentRecordType = ''; 

        function killMediaTracks() {
            if (screenStream) { screenStream.getTracks().forEach(t => t.stop()); screenStream = null; }
            if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
            if (combinedStream) { combinedStream.getTracks().forEach(t => t.stop()); combinedStream = null; }
            if (audioContext && audioContext.state !== 'closed') { audioContext.close(); audioContext = null; }
            document.querySelectorAll('.preview-video-el').forEach(v => { v.srcObject = null; });
        }

        function showRecorderMsg(type, msg, isError = false, keep = false) {
            const msgEl = document.getElementById(`${type}-record-status-msg`);
            if(!msgEl) return;
            msgEl.innerText = msg;
            msgEl.style.color = isError ? "var(--danger-color)" : "var(--slate-blue)";
            msgEl.style.display = 'block';
            if(!keep && !isError) setTimeout(() => msgEl.style.display = 'none', 5000);
        }

        async function setupRecording(type) {
            currentRecordType = type;
            showRecorderMsg(type, "ğŸ”„ æ­£åœ¨è«‹æ±‚éº¥å…‹é¢¨èˆ‡è¢å¹•æ¬Šé™...", false, true);
            const useCamera = document.getElementById(`${type}-use-camera-cb`) ? document.getElementById(`${type}-use-camera-cb`).checked : false;

            try {
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true, 
                        video: useCamera ? { width: 320, height: 240 } : false 
                    });
                } catch(micErr) {
                    showRecorderMsg(type, "âŒ æ‚¨å…ˆå‰å°é–äº†æ¬Šé™ï¼è«‹é»æ“Šç¶²å€åˆ—å·¦å´çš„ã€é–é ­ ğŸ”’ã€å°‡éº¥å…‹é¢¨è¨­ç‚ºå…è¨±ï¼Œä¸¦é‡æ–°æ•´ç†ã€‚", true, true);
                    return;
                }

                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { displaySurface: "monitor" }, 
                        audio: { systemAudio: "include", echoCancellation: false, noiseSuppression: false, autoGainControl: false }
                    });
                } catch(screenErr) {
                    showRecorderMsg(type, "âŒ æ‚¨å–æ¶ˆäº†è¢å¹•åˆ†äº«ï¼Œè«‹é‡æ–°é»æ“Šå•Ÿå‹•ã€‚", true, true);
                    killMediaTracks();
                    return;
                }

                if (screenStream.getAudioTracks().length === 0) {
                    killMediaTracks(); 
                    showRecorderMsg(type, "âŒ å•Ÿå‹•å¤±æ•—ï¼šæ‚¨å¿˜è¨˜å‹¾é¸å·¦ä¸‹è§’çš„ã€Œä¸€ä½µåˆ†äº«ç³»çµ±éŸ³è¨Šã€äº†ï¼è«‹é‡æ–°å•Ÿå‹•ä¸¦å‹™å¿…æ‰“å‹¾ã€‚", true, true);
                    return; 
                }

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const dest = audioContext.createMediaStreamDestination();
                
                if (micStream && micStream.getAudioTracks().length > 0) {
                    audioContext.createMediaStreamSource(micStream).connect(dest);
                }
                if (screenStream && screenStream.getAudioTracks().length > 0) {
                    audioContext.createMediaStreamSource(screenStream).connect(dest);
                }

                let tracks = [...screenStream.getVideoTracks(), ...dest.stream.getAudioTracks()];
                combinedStream = new MediaStream(tracks);

                const previewVideo = document.getElementById(`${type}-preview-video`);
                previewVideo.srcObject = combinedStream;
                previewVideo.style.display = 'block';
                previewVideo.muted = true; 

                document.getElementById(`${type}-btn-setup-record`).style.display = 'none';
                document.getElementById(`${type}-btn-start-record`).style.display = 'block';
                document.getElementById(`${type}-btn-cancel-record`).style.display = 'block';
                showRecorderMsg(type, "âœ… æˆæ¬ŠæˆåŠŸä¸”ç³»çµ±éŸ³å·²é€£æ¥ï¼è«‹é»æ“Šä¸‹æ–¹ç´…è‰²æŒ‰éˆ•é–‹å§‹éŒ„è£½ã€‚", false, true);

                screenStream.getVideoTracks()[0].onended = () => {
                    if(mediaRecorder && mediaRecorder.state === "recording") { stopRecording(currentRecordType); } else { cancelRecording(currentRecordType); }
                };
            } catch (err) {
                showRecorderMsg(type, "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message, true, true);
                killMediaTracks();
            }
        }

        function startRecording(type) {
            recordedChunks = [];
            let options;
            if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus')) {
                options = { mimeType: 'video/webm;codecs=vp8,opus', videoBitsPerSecond: 1200000 };
            } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
                options = { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 1200000 };
            } else {
                options = { videoBitsPerSecond: 1200000 };
            }

            mediaRecorder = new MediaRecorder(combinedStream, options);
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };

            mediaRecorder.onstop = async function() {
                const blob = new Blob(recordedChunks, { type: options.mimeType || 'video/webm' });
                const previewVideo = document.getElementById(`${type}-preview-video`);
                previewVideo.srcObject = null; 
                previewVideo.src = URL.createObjectURL(blob); 
                previewVideo.controls = true;
                previewVideo.muted = false; 
                
                document.getElementById(`${type}-btn-stop-record`).style.display = 'none';
                document.getElementById(`${type}-btn-cancel-record`).style.display = 'none';
                document.getElementById(`${type}-recorder-container`).classList.remove('recording');
                
                killMediaTracks(); 

                try {
                    showRecorderMsg(type, "â³ æ­£åœ¨èˆ‡ä¸­ç¹¼ç«™å»ºç«‹é€£ç·šé€šé“...", false, true);
                    
                    const initRes = await fetch(GAS_LIVE_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'init_upload', filename: `Temp_${Date.now()}.webm` })
                    });
                    const initData = await initRes.json();
                    
                    if (initData.status !== 'success') throw new Error(initData.message);
                    const uploadUrl = initData.uploadUrl;

                    // é€é GAS é€²è¡Œ 3MB ä¸­ç¹¼å‚³è¼¸ (å®Œç¾é¿é–‹ CORS)
                    const chunkSize = 3 * 1024 * 1024; 
                    const fileSize = blob.size;
                    let start = 0;
                    let fileId = null;

                    while (start < fileSize) {
                        const end = Math.min(start + chunkSize, fileSize);
                        const chunk = blob.slice(start, end);
                        const chunkBase64 = await blobToBase64(chunk);
                        
                        let progress = Math.round((start / fileSize) * 100);
                        showRecorderMsg(type, `â³ å½±ç‰‡ä¸Šå‚³ä¸­ï¼š${progress}% (è«‹å‹¿é—œé–‰ç¶²é )...`, false, true);

                        const response = await fetch(GAS_LIVE_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'upload_chunk',
                                uploadUrl: uploadUrl,
                                chunkBase64: chunkBase64,
                                start: start,
                                totalSize: fileSize
                            })
                        });

                        const data = await response.json();

                        if (data.status === 'resume') {
                            start = end; 
                        } else if (data.status === 'success') {
                            fileId = data.fileId;
                            break;
                        } else {
                            throw new Error(data.message);
                        }
                    }

                    document.getElementById(`${type}-video`).value = `https://drive.google.com/file/d/${fileId}/view`;
                    document.getElementById(`${type}-video-id`).value = fileId;
                    showRecorderMsg(type, "âœ… å½±ç‰‡ä¸Šå‚³æˆåŠŸï¼ç¶²å€å·²è‡ªå‹•å¡«å…¥ã€‚(ğŸ’¡ å‰›ä¸Šå‚³çš„å½±ç‰‡é›²ç«¯éœ€ 3~5 åˆ†é˜è™•ç†é è¦½)", false, true);
                    document.getElementById(`${type}-record-status-msg`).style.color = "var(--accent-green)";
                    document.getElementById(`${type}-btn-setup-record`).innerText = "é‡æ–°éŒ„è£½ (å°‡è¦†è“‹å‰ä¸€æ¬¡)";
                    document.getElementById(`${type}-btn-setup-record`).style.display = 'block';

                } catch(e) {
                    showRecorderMsg(type, "âŒ ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message, true, true);
                    document.getElementById(`${type}-btn-setup-record`).innerText = "é‡æ–°éŒ„è£½";
                    document.getElementById(`${type}-btn-setup-record`).style.display = 'block';
                }
            };

            mediaRecorder.start(1000); 
            document.getElementById(`${type}-btn-start-record`).style.display = 'none';
            document.getElementById(`${type}-btn-stop-record`).style.display = 'block';
            document.getElementById(`${type}-recorder-container`).classList.add('recording');
            showRecorderMsg(type, "ğŸ”´ æ­£åœ¨éŒ„è£½ä¸­... (æ‚¨èˆ‡é›»è…¦çš„è²éŸ³çš†æœƒè¢«åš´æ ¼éŒ„ä¸‹)", true, true);
        }

        function stopRecording(type) { if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop(); }

        function cancelRecording(type) {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop(); 
                mediaRecorder.onstop = () => { killMediaTracks(); resetRecordingUI(type); };
            } else {
                killMediaTracks();
                resetRecordingUI(type);
            }
        }

        function resetRecordingUI(type) {
            document.getElementById(`${type}-btn-setup-record`).innerText = "1. å•Ÿæ€’å½±éŸ³éŒ„è£½æ¬Šé™";
            document.getElementById(`${type}-btn-setup-record`).style.display = 'block';
            document.getElementById(`${type}-btn-start-record`).style.display = 'none';
            document.getElementById(`${type}-btn-stop-record`).style.display = 'none';
            document.getElementById(`${type}-btn-cancel-record`).style.display = 'none';
            document.getElementById(`${type}-preview-video`).style.display = 'none';
            document.getElementById(`${type}-preview-video`).src = '';
            document.getElementById(`${type}-record-status-msg`).style.display = 'none';
            document.getElementById(`${type}-recorder-container`).classList.remove('recording');
            document.getElementById(`${type}-video`).value = '';
            document.getElementById(`${type}-video-id`).value = '';
        }

        function blobToBase64(blob) {
            return new Promise((resolve, _) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }

        // ==========================================
        // ğŸ¯ ç¶²ç«™åŸºç¤é‚è¼¯èˆ‡é€šè¡Œè­‰æ©Ÿåˆ¶
        // ==========================================
        
        // ğŸ¯ æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦å·²ç¶“ç™»å…¥éï¼Œä¸”æœªè¶…é 1 å°æ™‚
        function checkAutoLogin() {
            const savedEmail = localStorage.getItem('troy_user_email');
            const loginTime = localStorage.getItem('troy_login_time');

            if (savedEmail && loginTime) {
                const now = new Date().getTime();
                const timeDiff = now - parseInt(loginTime);
                const oneHour = 60 * 60 * 1000; // 1å°æ™‚çš„æ¯«ç§’æ•¸

                if (timeDiff < oneHour) {
                    // å°šæœªéæœŸï¼Œè‡ªå‹•åŸ·è¡Œç™»å…¥ç•«é¢åˆ‡æ›
                    currentUserEmail = savedEmail;
                    document.getElementById('login-status').innerText = `å·²ç™»å…¥ï¼š${currentUserEmail}`;
                    document.getElementById('step-1').style.display = 'none';
                    document.getElementById('step-2').style.display = 'none';
                    document.getElementById('btn-logout').style.display = 'block';
                    document.getElementById('publish-section').style.display = 'block';
                    
                    // åˆ·æ–°ä¸€ä¸‹å„²å­˜çš„æ™‚é–“ï¼Œè®“ 1 å°æ™‚é‡æ–°è¨ˆç®— (å¯é¸)
                    localStorage.setItem('troy_login_time', now);
                } else {
                    // å·²ç¶“è¶…é 1 å°æ™‚ï¼Œæ¸…é™¤éæœŸçš„ç´€éŒ„
                    localStorage.removeItem('troy_user_email');
                    localStorage.removeItem('troy_login_time');
                }
            }
        }

        window.onload = function() {
            document.getElementById('list-section').style.display = 'block';
            renderTypeFilter();
            
            // ğŸ¯ æ–°å¢ï¼šç¶²é ä¸€è¼‰å…¥å°±å…ˆæª¢æŸ¥æœ‰æ²’æœ‰é€šè¡Œè­‰
            checkAutoLogin(); 
            
            fetchLiveData();
        };

        function showAppMsg(id, text, isError=false) {
            const el = document.getElementById(id);
            el.innerText = text;
            el.className = isError ? "inline-msg" : "inline-msg success";
            setTimeout(() => el.innerText = '', 4000);
        }
        
        function scrollToLogin() { window.scrollTo({ top: 0, behavior: 'smooth' }); document.getElementById('email').focus(); }

        function requestOTP() {
            const email = document.getElementById('email').value.trim();
            if (!email) return showAppMsg('otp-msg', 'è«‹å…ˆè¼¸å…¥ Email', true);
            document.getElementById('btn-otp').innerText = "å¯„é€ä¸­...";
            fetch(GAS_LIVE_URL, { method: 'POST', body: JSON.stringify({ action: 'requestOTP', email: email }) })
            .then(res => res.json()).then(data => {
                document.getElementById('btn-otp').innerText = "å¯„é€é©—è­‰ç¢¼";
                if (data.status === "error") return showAppMsg('otp-msg', data.message, true);
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'block';
            }).catch(() => { showAppMsg('otp-msg', 'é€£ç·šå¤±æ•—', true); document.getElementById('btn-otp').innerText = "å¯„é€é©—è­‰ç¢¼"; });
        }

        function verifyLogin() {
            const email = document.getElementById('email').value.trim();
            const otp = document.getElementById('otp-code').value.trim();
            if (!otp) return showAppMsg('login-msg', 'è«‹è¼¸å…¥é©—è­‰ç¢¼', true);

            document.getElementById('btn-login').innerText = "é©—è­‰ä¸­...";
            fetch(GAS_LIVE_URL, { method: 'POST', body: JSON.stringify({ action: 'verifyOTP', email: email, otp: otp }) })
            .then(res => res.json()).then(data => {
                document.getElementById('btn-login').innerText = "ç™»å…¥é€šè¡Œ";
                if (data.status === "error") return showAppMsg('login-msg', data.message, true);
                
                currentUserEmail = email;
                document.getElementById('login-status').innerText = `å·²ç™»å…¥ï¼š${email}`;
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'block';
                document.getElementById('publish-section').style.display = 'block';
                
                // ğŸ¯ æ–°å¢ï¼šç™»å…¥æˆåŠŸæ™‚ï¼ŒæŠŠ Email å’Œç•¶ä¸‹æ™‚é–“å­˜å…¥ç€è¦½å™¨
                localStorage.setItem('troy_user_email', currentUserEmail);
                localStorage.setItem('troy_login_time', new Date().getTime());

                if(currentPost && document.getElementById('detail-section').style.display === 'block') { enterClass(currentPost.courseId); }
            });
        }

        function logout() { 
            currentUserEmail = ''; 
            document.getElementById('email').value = ''; 
            document.getElementById('otp-code').value = ''; 
            document.getElementById('login-status').innerText = 'ç›®å‰ç‹€æ…‹ï¼šæœªç™»å…¥ (è¨ªå®¢)'; 
            document.getElementById('step-1').style.display = 'flex'; 
            document.getElementById('btn-logout').style.display = 'none'; 
            document.getElementById('publish-section').style.display = 'none';
            document.getElementById('detail-section').style.display = 'none';
            document.getElementById('list-section').style.display = 'block';
            
            // ğŸ¯ æ–°å¢ï¼šç™»å‡ºæ™‚æ¸…é™¤ç€è¦½å™¨ç´€éŒ„
            localStorage.removeItem('troy_user_email');
            localStorage.removeItem('troy_login_time');

            killMediaTracks(); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelLogin() { document.getElementById('step-1').style.display = 'flex'; document.getElementById('step-2').style.display = 'none'; }

        function renderTypeFilter() {
            const container = document.getElementById('type-container'); 
            container.innerHTML = '';
            ['å…¨éƒ¨', 'å¾…å›è¦†', 'æ•™ç·´å·²å›è¦†', 'å­¸å“¡è¿½å•'].forEach(opt => {
                const btn = document.createElement('button'); 
                btn.className = opt === currentStatus ? 'cat-btn active' : 'cat-btn';
                btn.innerText = opt; 
                btn.onclick = () => { currentStatus = opt; currentPage = 1; renderTypeFilter(); filterPosts(); };
                container.appendChild(btn);
            });
        }

        function clearDateFilter() { document.getElementById('datePicker').value = ''; filterPosts(); }

        function fetchLiveData() {
            fetch(GAS_LIVE_URL).then(res => res.json()).then(data => {
                allLiveData = data.reverse(); 
                document.getElementById('loading-list').style.display = 'none';
                filterPosts();
            }).catch(err => { document.getElementById('loading-list').innerText = 'è³‡æ–™è¼‰å…¥å¤±æ•—'; });
        }

        function filterPosts() {
            currentSearchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            let dateQuery = document.getElementById('datePicker').value.replace(/-/g, '/'); 
            
            let filtered = allLiveData;
            if (currentSearchQuery) {
                filtered = filtered.filter(p => (p.title && p.title.toLowerCase().includes(currentSearchQuery)) || (p.desc && p.desc.toLowerCase().includes(currentSearchQuery)) || (p.courseId && p.courseId.toLowerCase().includes(currentSearchQuery)) );
            }
            if (currentStatus !== 'å…¨éƒ¨') filtered = filtered.filter(p => p.status === currentStatus);
            if (dateQuery) filtered = filtered.filter(p => p.date === dateQuery);

            renderList(filtered);
        }

        function renderList(filteredData) {
            const listContainer = document.getElementById('post-list');
            const pagination = document.getElementById('pagination-container');
            listContainer.innerHTML = ''; pagination.innerHTML = '';

            if (filteredData.length === 0) return listContainer.innerHTML = '<p class="system-msg">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„ï¼</p>';

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const postsToShow = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            postsToShow.forEach(post => {
                let badgeClass = post.status.includes('å·²å›è¦†') ? 'tag-replied' : 'tag-pending';
                
                listContainer.innerHTML += `
                    <div class="post-card">
                        <div class="post-title-row">
                            <h3 class="post-title">${post.title}</h3>
                            <span class="tag-badge ${badgeClass}">${post.status}</span>
                        </div>
                        <div class="post-meta">
                            <span>ç·¨è™Ÿï¼š${post.courseId}</span>
                            <span>ç™¼ä½ˆäººï¼š${post.email.split('@')[0]}***</span> 
                            <span>ç™¼ä½ˆæ–¼ï¼š${post.date} ${post.time}</span>
                        </div>
                        <div class="post-excerpt">${post.desc}</div>
                        <button onclick="enterClass('${post.courseId}')" class="btn-outline" style="width: auto;">é€²å…¥æ—¥èªŒ</button>
                    </div>`;
            });

            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button'); btn.className = `page-btn ${i === currentPage ? 'active' : ''}`; btn.innerText = i;
                    btn.onclick = () => { currentPage = i; renderList(filteredData); window.scrollTo({ top: 0, behavior: 'smooth' }); };
                    pagination.appendChild(btn);
                }
            }
        }

        function getDriveIframe(url) {
            if (!url) return '';
            const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/) || url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return `
                <div class="video-wrapper">
                    <div class="video-container">
                        <iframe src="https://drive.google.com/file/d/${match[1]}/preview" allowfullscreen></iframe>
                    </div>
                </div>`;
            }
            return `<a href="${url}" target="_blank" class="thread-video-link">ğŸ¥ è§€çœ‹å¤–éƒ¨å½±ç‰‡</a>`;
        }

        function renderThread(post) {
            let html = '';
            let vidHtml = getDriveIframe(post.videoUrl);
            html += `
                <div class="thread-item student">
                    <div class="thread-header">
                        <span class="thread-role">ğŸ‘¤ å­¸å“¡æå• (${post.email})</span>
                        <span class="thread-time">${post.date} ${post.time}</span>
                    </div>
                    <div class="post-excerpt">${post.desc.replace(/\n/g, '<br>')}</div>
                    ${vidHtml}
                </div>`;
            
            post.replies.forEach(reply => {
                let parts = reply.split('|||');
                if(parts.length >= 5) {
                    let rDate = parts[0], rTime = parts[1], rRole = parts[2], rEmail = parts[3], rContent = parts[4], rVid = parts[5] || '';
                    let itemClass = rRole === 'é™ªè·‘æ•™ç·´' ? 'coach' : 'student';
                    let rVidHtml = getDriveIframe(rVid);
                    
                    html += `
                    <div class="thread-item ${itemClass}">
                        <div class="thread-header">
                            <span class="thread-role">${rRole === 'é™ªè·‘æ•™ç·´' ? 'ğŸ‘‘' : 'ğŸ‘¤'} ${rRole} (${rEmail})</span>
                            <span class="thread-time">${rDate} ${rTime}</span>
                        </div>
                        <div class="post-excerpt">${rContent.replace(/\n/g, '<br>')}</div>
                        ${rVidHtml}
                    </div>`;
                }
            });
            document.getElementById('thread-container').innerHTML = html;
        }

        function enterClass(courseId) {
            currentPost = allLiveData.find(p => p.courseId === courseId);
            if(!currentPost) return;

            document.getElementById('publish-section').style.display = 'none';
            document.getElementById('list-section').style.display = 'none';
            document.getElementById('detail-section').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

            document.getElementById('detail-title').innerText = currentPost.title;
            document.getElementById('detail-meta').innerHTML = `<span>ç·¨è™Ÿ: ${currentPost.courseId}</span> <span>ç‹€æ…‹: ${currentPost.status}</span>`;
            
            const authWarningContainer = document.getElementById('auth-warning-container');
            const authWarningMessage = document.getElementById('auth-warning-message');
            const authWarningBtn = document.getElementById('auth-warning-btn');
            const threadContentWrapper = document.getElementById('thread-content-wrapper');

            if (!currentUserEmail) {
                authWarningContainer.style.display = 'flex';
                threadContentWrapper.style.display = 'none';
                authWarningMessage.innerHTML = "ğŸ”’ é€™æ˜¯å°ˆå±¬é™ªè·‘æ—¥èªŒ<br>è«‹å…ˆç™»å…¥æˆ–åŠ å…¥æœƒå“¡ä»¥è§£é–æ‚¨çš„æ¬Šé™ï¼";
                authWarningBtn.style.display = 'inline-block';
            } else if (currentUserEmail.toLowerCase() !== currentPost.email.toLowerCase() && currentUserEmail.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                authWarningContainer.style.display = 'flex';
                threadContentWrapper.style.display = 'none';
                authWarningMessage.innerHTML = "â›” é€™æ˜¯å…¶ä»–å­¸å“¡çš„å°ˆå±¬é™ªè·‘æ—¥èªŒ<br>ç‚ºä¿éšœå­¸å“¡éš±ç§ï¼Œæ‚¨ç„¡æ¬Šè§€çœ‹å“¦ï¼";
                authWarningBtn.style.display = 'none'; 
            } else {
                authWarningContainer.style.display = 'none';
                threadContentWrapper.style.display = 'block';
                renderThread(currentPost);
            }
        }

        function submitPost() {
            const title = document.getElementById('post-title').value.trim();
            const desc = document.getElementById('post-desc').value.trim();
            const videoUrl = document.getElementById('post-video').value.trim();
            const videoFileId = document.getElementById('post-video-id').value; 
            const btn = document.getElementById('btn-submit-post');
            
            if(!title || !desc) return showAppMsg('post-msg', 'æ¨™é¡Œèˆ‡ç°¡è¿°ç‚ºå¿…å¡«ï¼', true);
            
            btn.disabled = true; btn.innerText = "ç™¼å¸ƒä¸­...";

            fetch(GAS_LIVE_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'add_post', 
                    email: currentUserEmail, 
                    title: title, 
                    desc: desc, 
                    videoUrl: videoUrl,
                    videoFileId: videoFileId 
                })
            }).then(() => {
                btn.disabled = false; btn.innerText = "ğŸš€ ç™¼å¸ƒæå•";
                document.getElementById('post-title').value = ''; 
                document.getElementById('post-desc').value = ''; 
                resetRecordingUI('post'); 
                showAppMsg('post-msg', 'æå•ç™¼å¸ƒæˆåŠŸï¼');
                fetchLiveData(); 
            });
        }

        function submitReply() {
            const desc = document.getElementById('reply-desc').value.trim();
            const videoUrl = document.getElementById('reply-video').value.trim();
            const videoFileId = document.getElementById('reply-video-id').value; 
            const btn = document.getElementById('btn-submit-reply');
            
            if(!desc) return showAppMsg('reply-msg', 'è«‹è¼¸å…¥å›è¦†å…§å®¹ï¼', true);
            
            btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";

            fetch(GAS_LIVE_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'add_reply', 
                    courseId: currentPost.courseId, 
                    email: currentUserEmail, 
                    desc: desc, 
                    videoUrl: videoUrl,
                    videoFileId: videoFileId
                })
            }).then(() => {
                btn.disabled = false; btn.innerText = "ğŸš€ é€å‡ºå›è¦†";
                document.getElementById('reply-desc').value = ''; 
                resetRecordingUI('reply'); 
                showAppMsg('reply-msg', 'å›è¦†æˆåŠŸï¼é‡æ–°è¼‰å…¥ä¸­...');
                
                fetch(GAS_LIVE_URL).then(res=>res.json()).then(data => {
                    allLiveData = data.reverse();
                    enterClass(currentPost.courseId);
                });
            });
        }

        function backToList() {
            document.getElementById('detail-section').style.display = 'none';
            document.getElementById('list-section').style.display = 'block';
            if(currentUserEmail) document.getElementById('publish-section').style.display = 'block';
            killMediaTracks(); 
            resetRecordingUI('post');
            resetRecordingUI('reply');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            filterPosts();
        }
    </script>
</body>
</html>
